<!doctype html>
<html>
	<head>
		<title>Game of Life</title>
		<link rel="stylesheet" href="./styles/styles.css" />
		<script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js'></script>
		<script src="./js/drawGrid.js"></script>
		<script src="./js/drawBip.js"></script>
	</head>
	<body>
		<h1>Welcome to the game of life!</h1>
		<canvas id='main' width='800' height='400'></canvas>
		<div>
			<label>X Position</label>
			<input id='xpos' type='text'/>
		</div>
		<div>
			<label>Y Position</label>
			<input id='ypos' type='text'/>
		</div>
		<div>
			<label>Time in Seconds</label>
			<input id='time' type='text'/>
		</div>
		<div>
			<button onclick=handleFlipBipClick()>Flip Bip</button>
		</div>
		<div>
			<button onclick=handleIterationClick()>Iterate</button>
		</div>
		<div>
			<button onclick=handleSetIntervalClick()>Begin Interval</button>
		</div>
		<div>
			<button onclick=clearRefreshInterval()>Stop Interval</button>
		</div>
		<div>
			<button onclick=initializeBoard()>Clear Board</button>
		</div>

		<script>
			function handleGridClick(event) {
				let xPos = Math.floor((Math.floor(event.layerX) - 1)/scale);
				let yPos = Math.floor((Math.floor(event.layerY) - 2)/scale);
				bips = flipBip(xPos, yPos, bips);
				refreshBoard(ctx, bips);
			}

			function initializeBoard() {
				clearRefreshInterval();
				let xSize = ctx.canvas.width / scale;
				let ySize = ctx.canvas.height / scale;
				bips = initializeBips(xSize, ySize);
				drawBoard(ctx, bips)
			}

			function initializeBips(xSize, ySize, initialBips) {
				let newBips = [];
				for (let x = 0; x < xSize; x++) {
					let xRow = [];
					for (let y = 0; y < ySize; y++) {
						xRow.push({x: x, y: y, alive: false})
					}
					newBips.push(xRow);
				}
				return newBips;
			}

			function handleFlipBipClick() {
				let x = parseInt(document.getElementById('xpos').value);
				let y = parseInt(document.getElementById('ypos').value);
				bips = flipBip(x, y, bips);
				refreshBoard(ctx, bips);
			}

			function handleIterationClick() {
				bips = repopulateBips(bips);
				refreshBoard(ctx, bips);
			}

			function handleSetIntervalClick() {
				let time = parseInt(document.getElementById('time').value) || .25
				setRefreshInterval(time);
			}

			function setRefreshInterval(time) {
				let timeInMilliseconds =  time * 1000
				clearRefreshInterval();
				interval = setInterval(handleIterationClick, timeInMilliseconds);
				console.log('Interval:', interval);
			}

			function clearRefreshInterval() {
				console.log('Clearing interval:', interval);
				if(interval) {
					clearInterval(interval);
					interval = undefined;
				}
			}

			function clearBoard(ctx) {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
			}

			function drawBoard(ctx, bips) {
				for(var xRows of bips) {
					for(var b of xRows) {
						drawBip(ctx, {x: b.x, y:b.y, s:scale, value: b.alive, offColor:'darkgrey'});
					}
				}
				drawGrid(ctx, 10, 10, 'black');
			}

			function refreshBoard(ctx, bips) {
				clearBoard(ctx);
				drawBoard(ctx, bips);
			}

			function flipBip(x, y, bips) {
				let newBips = _.cloneDeep(bips);
				let newVal = !newBips[x][y].alive;
				newBips[x][y] = {x: x, y: y, alive: newVal};
				return newBips;
			}

			function livingNeighbors(bipsArray, currentBip) {
				let neighborsAlive = -1 * currentBip.alive;
				let xMin = currentBip.x < 1 ? 0 : currentBip.x - 1
				let yMin = currentBip.y < 1 ? 0 : currentBip.y - 1
				let xMax = currentBip.x >= bipsArray.length - 1 ? bipsArray.length - 2 : currentBip.x + 1;
				let yMax = currentBip.y >= bipsArray[0].length - 1 ? bipsArray[0].length - 2 : currentBip.y + 1;

				for(let x = xMin; x <= xMax; x++ ) {
					for(let y = yMin; y <= yMax; y++) {
						neighborsAlive += (bipsArray[x][y].alive * 1);
					}
				}
				return neighborsAlive;
			}

			function repopulateBips(bipsArray) {
				let newBips = _.cloneDeep(bipsArray);
				newBips.forEach( arr => {
					arr.forEach( bip => {
						if (bip.alive && livingNeighbors(bipsArray, bip) < 2) {
							bip.alive = false;
						} else if (bip.alive && (livingNeighbors(bipsArray, bip) == 2 || livingNeighbors(bipsArray, bip) == 3)) {
							bip.alive = true;
						} else if (bip.alive && livingNeighbors(bipsArray, bip) > 3) {
							bip.alive = false;
						} else if (!bip.alive && livingNeighbors(bipsArray, bip) == 3) {
							bip.alive = true;
						}
					});
				});
				return newBips;
			}

			let interval;

			let scale = 10;
			let ctx = document.getElementById('main').getContext('2d');
			ctx.canvas.addEventListener("click", handleGridClick);
			let bips = [];
			initializeBoard();
		</script>
	</body>
</html>